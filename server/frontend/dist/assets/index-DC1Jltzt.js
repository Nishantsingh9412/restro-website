import{j as t,B as w,F as h,b as S,p as Y,o as V,W as A,P as m,S as $,H as F,aa as B}from"./chakra-B_DUJliM.js";import{G as H}from"./index.esm-C8Ls1WbU.js";import{b as N}from"./index.esm-C2w5JDxg.js";import{g as v}from"./index.esm-CEhDG2xH.js";import{a as W}from"./index.esm-B5MM-5XA.js";import{aI as i,ab as M,aJ as O}from"./index-C674oLPn.js";import{u as G,f as T}from"./redux-BFEnBRFN.js";import{r as d}from"./react-D9OIIVWL.js";import{g as J,u as U,c as Z}from"./delivery-Bm5znWSv.js";import{t as D}from"./maps.min-Dvnb-tJ8.js";import{t as Q}from"./services.min-Ctqw3Iy1.js";import"./toast-D556Fe1H.js";function q({data:r,handleUpdateStatus:x,disabled:p}){var f;const l=(g=>{switch(g){case i.AVAILABLE:return{status:i.PICKED_UP,color:"blue.500"};case i.PICKED_UP:case i.OUT_FOR_DELIVERY:return{status:i.DELIVERED,color:"green.500"};case i.DELIVERED:return{status:i.COMPLETED,color:"purple.500"};case i.CANCELLED:return{status:i.AVAILABLE,color:"red.500"};default:return{status:"Completed",color:"gray.500"}}})(r.currentStatus);return t.jsx(w,{borderRadius:8,bg:"white",p:4,maxW:"600px",boxShadow:"lg",border:"1px solid #e2e8f0",children:t.jsx(h,{flexDirection:"row",gap:4,children:t.jsxs(h,{flexDirection:"column",flex:1,gap:2,children:[t.jsxs(h,{justifyContent:"space-between",children:[t.jsxs(w,{children:[t.jsx(S,{fontSize:20,fontWeight:"bold",children:r.customerName}),t.jsxs(S,{fontSize:16,color:"gray.600",children:["Order #",r.orderId]}),t.jsx(S,{bg:"gray.200",w:"fit-content",mt:2,px:2,py:1,fontSize:14,borderRadius:8,children:(f=r.paymentType)==null?void 0:f.toUpperCase()})]}),t.jsx(w,{width:"50px",height:"50px",borderRadius:"50%",overflow:"hidden",children:t.jsx(Y,{src:r.customerImage??"https://res.cloudinary.com/dezifvepx/image/upload/v1712570097/restro-website/dtqy5kkrwuuhamtp9gim.png",alt:r.customerName})})]}),t.jsxs(h,{gap:4,mt:2,children:[t.jsxs(h,{alignItems:"center",border:"1px solid #ccc",p:2,borderRadius:5,flex:1,fontSize:14,children:[t.jsx(H,{}),t.jsx(W,{}),t.jsx(N,{}),t.jsxs(S,{ml:2,children:[(r.distance/1e3).toFixed(1)," km"]})]}),t.jsxs(h,{alignItems:"center",border:"1px solid #ccc",p:2,borderRadius:5,flex:1,fontSize:14,children:[t.jsx(v,{}),t.jsxs(S,{ml:2,children:[Math.ceil(r.estimatedTime/60)," min."]})]})]}),t.jsx(h,{gap:2,mt:4,children:t.jsx(V,{p:2,flex:1,bg:p?"#ccc":l.color,_hover:{background:p?null:l.color.split(".")[0]+".600"},color:"#fff",_disabled:{background:"#ccc",pointerEvents:"none"},disabled:p,onClick:p?null:()=>x(r._id,l.status),fontSize:14,children:l.status})})]})})})}q.propTypes={data:A.PropTypes.object,handleUpdateStatus:A.PropTypes.func,disabled:A.PropTypes.bool};const z="hvJOAVf5ZbSAzx17QYIVaeMP5vEeUwpR",X={width:"100%",height:"500px"},L=r=>r&&typeof r.lat=="number"&&typeof r.lng=="number",K=({currentLocation:r,pickupLocation:x,dropPoints:p})=>{const I=d.useRef(null),l=d.useRef(null),f=d.useRef(null),g=d.useRef({}),k=()=>{const s=D.map({key:z,container:I.current,center:[r.lng,r.lat],zoom:14});l.current=s,s.on("load",y)},C=()=>{const s="0123456789ABCDEF";let a="#";for(let e=0;e<6;e++)a+=s[Math.floor(Math.random()*16)];return a="#"+"012345".charAt(Math.floor(Math.random()*6))+a.slice(2),a},R=(s,a,e,c)=>{if(!L(a))return;const o=document.createElement("div");o.style.backgroundColor=c,o.style.width="20px",o.style.height="20px",o.style.borderRadius="50%",o.style.border="2px solid white";const n=document.createElement("div"),E=document.createElement("img");E.src="https://img.icons8.com/ios-filled/50/FF0000/marker.png",E.style.width="30px",E.style.height="30px",n.appendChild(E);const b=e.includes("Pickup")?n:o,j=new D.Marker({element:b}).setLngLat([a.lng,a.lat]).setPopup(new D.Popup().setHTML(e)).addTo(s);g.current[a.orderId]=j},P=s=>{Object.keys(g.current).forEach(a=>{s.includes(a)||(g.current[a].remove(),delete g.current[a])})},u=async(s,a,e,c)=>{if(!(!L(a)||!L(e)))try{const b={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:(await Q.services.calculateRoute({key:z,locations:[`${a.lng},${a.lat}`,`${e.lng},${e.lat}`],traffic:!1})).routes[0].legs[0].points.map(_=>[_.lng,_.lat])}}]},j=`route-${e.orderId}`;s.getSource(j)?s.getSource(j).setData(b):(s.addSource(j,{type:"geojson",data:b}),s.addLayer({id:j,type:"line",source:j,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":c,"line-width":6,"line-opacity":.8}}))}catch(o){console.error("Failed to draw route",o)}},y=()=>{if(!l.current)return;const s=l.current;if(!s||!s.getStyle()||!s.getStyle().layers)return;R(s,x,"Pickup Location","#FFA500"),p.forEach(o=>{const n=C();g.current[o.orderId]||R(s,o,`Drop Point (Order ID: ${o.orderId})`,n),u(s,r??x,o,n)});const a=p.map(o=>`route-${o.orderId}`),e=p.map(o=>o.orderId);P(e),(s.getStyle().layers||[]).forEach(o=>{o.id.includes("route-")&&!a.includes(o.id)&&(s.removeLayer(o.id),s.removeSource(o.id))})};return d.useEffect(()=>{var s;if(!L(r)||!L(x)||!Array.isArray(p)){console.error("Invalid locations provided");return}l.current?(s=l.current)!=null&&s.loaded()&&y():k()},[x,p,r]),d.useEffect(()=>{if(!l.current)return;const s=l.current;if(f.current)f.current.setLngLat([r.lng,r.lat]);else{const a=document.createElement("div"),e=document.createElement("img");e.src="https://img.icons8.com/?size=100&id=HZC1E42sHiI3&format=png&color=000000",e.style.width="30px",e.style.height="30px",a.appendChild(e),f.current=new D.Marker({element:a}).setLngLat([r.lng,r.lat]).setPopup(new D.Popup().setHTML("Current Location")).addTo(s)}s.setCenter([r.lng,r.lat])},[r]),t.jsx("div",{ref:I,style:X})};K.propTypes={currentLocation:m.shape({lat:m.number.isRequired,lng:m.number.isRequired}).isRequired,pickupLocation:m.shape({lat:m.number.isRequired,lng:m.number.isRequired}).isRequired,dropPoints:m.arrayOf(m.shape({lat:m.number.isRequired,lng:m.number.isRequired,orderId:m.string.isRequired})).isRequired};function de(){const r=G(),[x,p]=d.useState(!0),[I,l]=d.useState(!1),[f,g]=d.useState(null),[k,C]=d.useState([]),R=T(e=>e.userReducer.data),P=T(e=>{const c=e.location.currentLocation;return c!=null&&c.lat&&(c!=null&&c.lng)?c:(R==null?void 0:R.lastLocation)||f}),u=T(e=>e.deliveryReducer.deliveries||[]),y=e=>{u.length===1&&O(),r(Z(e)).then(()=>M.showOrderCompleted())},s=(e,c)=>{if(c===i.DELIVERED)return y(e);r(U(e,c))},a=()=>{u.forEach(e=>{(e==null?void 0:e.currentStatus)===i.PICKED_UP&&r(U(e==null?void 0:e._id,i.OUT_FOR_DELIVERY))}),O()};return d.useEffect(()=>{Promise.all([r(J())]).then(()=>p(!1))},[r]),d.useEffect(()=>{var e;if(u.length>0){const c=u.every(({currentStatus:n})=>n===i.PICKED_UP);l(c),g((e=u[0])==null?void 0:e.pickupLocation);const o=[];return u.map(n=>{var E,b;((n==null?void 0:n.currentStatus)===i.PICKED_UP||(n==null?void 0:n.currentStatus)===i.OUT_FOR_DELIVERY)&&o.push({orderId:n==null?void 0:n.orderId,lat:(E=n==null?void 0:n.deliveryLocation)==null?void 0:E.lat,lng:(b=n==null?void 0:n.deliveryLocation)==null?void 0:b.lng})}),C(o),()=>{C([])}}},[u]),x?t.jsx(h,{justifyContent:"center",alignItems:"center",height:"50vh",children:t.jsx($,{size:"xl"})}):t.jsx(t.Fragment,{children:u.length===0?t.jsx(S,{p:3,w:"fit-content",bg:"rgba(255, 255, 255, 0.5)",mx:"auto",my:20,children:"You don't have any delivery offer at this moment"}):t.jsxs(t.Fragment,{children:[t.jsx(F,{fontSize:20,my:5,children:"Navigation Map"}),t.jsx(K,{currentLocation:P??f,pickupLocation:f,dropPoints:k}),t.jsxs(h,{justifyContent:"space-between",alignItems:"center",mt:10,children:[t.jsx(F,{fontSize:20,children:"Available Deliveries"}),I&&t.jsx(V,{colorScheme:"orange",onClick:()=>M.showStatusChangeConfirm(null,i.OUT_FOR_DELIVERY,a),mb:5,fontWeight:"bold",children:"Out for Delivery"})]}),t.jsx(B,{gap:5,gridTemplateColumns:{base:"1fr",md:"1fr 1fr",lg:"1fr 1fr 1fr"},children:u==null?void 0:u.map((e,c)=>t.jsx(q,{data:e,handleUpdateStatus:(o,n)=>M.showStatusChangeConfirm(o,n,s),disabled:(e==null?void 0:e.currentStatus)===i.PICKED_UP},c))})]})})}export{de as default};
