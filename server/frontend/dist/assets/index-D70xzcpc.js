import{j as e,r as H,s as V,t as q,v as G,w as W,O as C,x as Y,o as $,g as J,B as S,as as K,F as E,b as y,R as z,H as w,at as N,a8 as Q}from"./chakra-B_DUJliM.js";import{r as a}from"./react-D9OIIVWL.js";import{al as P,am as U,r as Z,an as X}from"./index-C674oLPn.js";import{t as v}from"./maps.min-Dvnb-tJ8.js";import{s as b}from"./services.min-Ctqw3Iy1.js";import{f as ee}from"./redux-BFEnBRFN.js";import{F as te}from"./ForbiddenPage-DOSjSRWN.js";import"./toast-D556Fe1H.js";import"./index.esm-CEhDG2xH.js";const re=({isOpen:t,onClose:g,delEmpId:u,lastLocation:i})=>{const d=a.useRef(null),r=a.useRef(null),f=a.useRef(null),M=a.useRef(null),[n,c]=a.useState(null),[B,L]=a.useState(0),T="hvJOAVf5ZbSAzx17QYIVaeMP5vEeUwpR",p=ee(s=>s.location.deliveryBoyLocations.find(o=>o._id===u)),l=a.useMemo(()=>p?{lat:p.location.latitude,lng:p.location.longitude}:{lat:(i==null?void 0:i.lat)??22.5678,lng:(i==null?void 0:i.lng)??88.372},[p,i]),[x,m,A=[]]=a.useMemo(()=>[n==null?void 0:n.dropLocation,n==null?void 0:n.deliveryLocation],[n]),D=async()=>{try{const{data:s}=await U(u);s&&c(s.result)}catch(s){console.error("Error fetching active delivery:",s)}};a.useEffect(()=>{u&&D()},[u]),a.useEffect(()=>{t&&(n?s():setTimeout(s,500));function s(){d.current&&!r.current&&(r.current=v.map({key:T,container:d.current,center:[l.lng,l.lat],zoom:13}),f.current=new v.Marker().setLngLat([l.lng,l.lat]),f.current.addTo(r.current),O())}return()=>{r.current&&(r.current.remove(),r.current=null,f.current=null,M.current=null,L(0))}},[t,n]),a.useEffect(()=>{if(r.current&&l&&(f.current.setLngLat([l.lng,l.lat]),r.current.flyTo({center:[l.lng,l.lat]}),n!=null&&n.dropLocation)){const s=_(n.dropLocation,l);L(o=>o+s)}},[l]);const O=()=>{if(!x||!m)return;const s=[x,...A,m];b.services.calculateRoute({key:T,locations:s.map(o=>`${o.lng},${o.lat}`).join(":")}).then(o=>{const R=o.routes[0].legs.flatMap(h=>h.points.map(j=>[j.lng,j.lat]));r.current.getLayer("route-layer")&&r.current.removeLayer("route-layer"),r.current.getSource("route-layer")&&r.current.removeSource("route-layer"),r.current.addSource("route-layer",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:R}}}),r.current.addLayer({id:"route-layer",type:"line",source:"route-layer",paint:{"line-color":"#4a90e2","line-width":5}}),new v.Marker({color:"green"}).setLngLat([x.lng,x.lat]).addTo(r.current),new v.Marker({color:"red"}).setLngLat([m.lng,m.lat]).addTo(r.current)}).catch(o=>console.error("Error fetching route:",o))},_=(s,o)=>{const h=I=>I*Math.PI/180,j=h(o.lat-s.lat),F=h(o.lng-s.lng),k=Math.sin(j/2)**2+Math.cos(h(s.lat))*Math.cos(h(o.lat))*Math.sin(F/2)**2;return 6371e3*2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k))};return e.jsxs(H,{isOpen:t,onClose:g,size:"5xl",children:[e.jsx(V,{}),e.jsxs(q,{children:[e.jsx(G,{children:"Live Tracking & Route Guidance"}),e.jsxs(W,{children:[e.jsx("div",{ref:d,style:{width:"100%",height:"400px"}}),e.jsxs("div",{style:{marginTop:"10px",display:"flex",justifyContent:"space-between"},children:[e.jsx(C,{onClick:()=>r.current.flyTo({center:[l.lng,l.lat]}),icon:e.jsx(P,{})}),e.jsxs("p",{children:["Distance Traveled: ",(B/1e3).toFixed(2)," km"]})]})]}),e.jsx(Y,{children:e.jsx($,{onClick:g,children:"Close"})})]})]})},ne=({boy:t,handleDeleteDelboy:g,handleEdit:u})=>{const{isOpen:i,onClose:d,onOpen:r}=J();return e.jsx(S,{p:"6",boxShadow:"lg",borderWidth:"1px",borderRadius:"lg",bg:"white",_hover:{boxShadow:"xl"},transition:"all 0.3s",children:e.jsxs(K,{align:"start",spacing:"2",children:[e.jsxs(E,{w:"full",justifyContent:"space-between",children:[e.jsxs(y,{fontWeight:"bold",fontSize:"lg",children:[t==null?void 0:t.name," "]}),e.jsxs(z,{spacing:"2",children:["/* Show offline icon when delivery boy is offline and no location shared */",e.jsx(C,{icon:e.jsx(P,{}),"aria-label":"Location Track",colorScheme:"blue",size:"sm",onClick:r}),i&&e.jsx(re,{isOpen:i,onClose:d,delEmpId:t==null?void 0:t._id,lastLocation:t==null?void 0:t.lastLocation})]})]}),e.jsxs(y,{children:["Phone: ",t==null?void 0:t.phone]}),e.jsxs(y,{children:["Country Code: ",t==null?void 0:t.country_code]})]})})},fe=()=>{const[t,g]=a.useState(!0),[u,i]=a.useState([]),[d,r]=a.useState(!0),f=Z(),M=async()=>{var n;try{g(!0);const c=await X();i((n=c==null?void 0:c.data)!=null&&n.result.length?c==null?void 0:c.data.result:[])}catch(c){c.status===403&&r(!1),f(c.response.data.error,"error")}finally{g(!1)}};return a.useEffect(()=>{M()},[]),t?e.jsx(S,{mt:"2vw",ml:"2vw",p:"4",bg:"gray.50",minH:"100vh",borderRadius:"10px",display:"flex",justifyContent:"center",alignItems:"center",children:e.jsx(w,{size:"lg",children:"Loading..."})}):d?e.jsxs(S,{mt:"2vw",ml:"2vw",p:"4",bg:"gray.50",minH:"100vh",borderRadius:"10px",children:[e.jsxs(E,{mb:"4",alignItems:"center",children:[e.jsx(w,{size:"lg",children:"Active Delivery Partners"}),e.jsx(N,{}),e.jsx(z,{spacing:"4"})]}),u.length===0?e.jsx(w,{size:"md",mt:"100",textAlign:"center",children:"No active delivery partners found."}):e.jsx(Q,{columns:{sm:1,md:2,lg:3},spacing:"4",mt:"2",children:u.map(n=>e.jsx(ne,{boy:n},n==null?void 0:n._id))})]}):e.jsx(te,{isPermitted:d})};export{fe as default};
